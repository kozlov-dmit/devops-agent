from __future__ import annotations

from typing import Any, Dict, List


SYSTEM_PROMPT = """Ты — ведущий инженер по производительности и надежности (SRE / Performance Engineer).

Ты анализируешь инциденты ИСКЛЮЧИТЕЛЬНО на основе:
1) описания инцидента
2) логов и трейсов из инцидента
3) переданных фрагментов кода и конфигурации

ЗАПРЕЩЕНО:
- выдумывать файлы, классы, методы, конфигурационные ключи
- ссылаться на строки или пути, которых нет в контексте
- делать выводы без указания доказательств

Если данных недостаточно — прямо укажи, каких данных не хватает.
Ответ ОБЯЗАТЕЛЬНО должен быть валидным JSON без дополнительного текста.
"""


def build_user_prompt(*, incident: Dict[str, Any], contexts: List[Dict[str, Any]]) -> str:
    return (
        "ИНЦИДЕНТ (JSON):\n"
        f"{incident}\n\n"
        "КОНТЕКСТ (фрагменты кода и конфигурации — это единственный источник истины):\n"
        + "\n\n".join(
            [
                (
                    f"[score={c['score']:.4f} base={c['base']:.4f} rr={c['rr']:+.2f}] "
                    f"{c['path']}:{c['start_line']}-{c['end_line']} ({c['language']})\n"
                    "----- НАЧАЛО ФРАГМЕНТА -----\n"
                    f"{c['text']}\n"
                    "----- КОНЕЦ ФРАГМЕНТА -----"
                )
                for c in contexts
            ]
        )
        + "\n\n"
        "ЗАДАЧА:\n"
        "1) Найди наиболее вероятные узкие места или причины деградации/ошибок.\n"
        "2) Каждую гипотезу ОБЯЗАТЕЛЬНО подкрепи доказательствами из фрагментов (путь + строки).\n"
        "3) Опиши возможное влияние на систему (латентность, ошибки, деградация).\n"
        "4) Предложи конкретные проверки (метрики, логи, команды), чтобы подтвердить или опровергнуть гипотезу.\n"
        "5) Предложи практические способы исправления или смягчения.\n\n"
        "ФОРМАТ ОТВЕТА (СТРОГО JSON):\n"
        "{\n"
        '  "summary": "краткое резюме проблемы",\n'
        '  "classification": {"type": "тип проблемы", "confidence": 0.0},\n'
        '  "hypotheses": [\n'
        "    {\n"
        '      "title": "название гипотезы",\n'
        '      "confidence": 0.0,\n'
        '      "evidence": [\n'
        '        {"path": "путь к файлу", "lines": "start-end", "why": "почему это важно"}\n'
        "      ],\n"
        '      "impact": "чем это грозит системе",\n'
        '      "fixes": ["конкретное действие 1", "конкретное действие 2"]\n'
        "    }\n"
        "  ],\n"
        '  "hotspots": [\n'
        '    {"path": "путь к файлу", "lines": "start-end", "reason": "почему это узкое место"}\n'
        "  ],\n"
        '  "checks": ["что проверить в первую очередь"],\n'
        '  "missing_data": ["каких данных не хватает для уверенного вывода"]\n'
        "}\n"
    )
